\ Copyright (C) 2016 Peter Graves <gnooth@gmail.com>

\ This program is free software: you can redistribute it and/or modify
\ it under the terms of the GNU General Public License as published by
\ the Free Software Foundation, either version 3 of the License, or
\ (at your option) any later version.

\ This program is distributed in the hope that it will be useful,
\ but WITHOUT ANY WARRANTY; without even the implied warranty of
\ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
\ GNU General Public License for more details.

\ You should have received a copy of the GNU General Public License
\ along with this program.  If not, see <http://www.gnu.org/licenses/>.

require-system-file test-framework

LANGUAGE: feline

CONTEXT: feline forth ;
CURRENT: feline

0 value s1
0 value s2
0 value s3
0 value s4

s" this is a test" >transient-string to s1

test: test1
    s1 object? check-t
    s1 string? check-t
    s1 string-length 14 = check-t
    s1 check-string string-length 14 = check-t
    s1 string> s" this is a test" str= tag-boolean check-t
    s1 check-string string> s" this is a test" str= tag-boolean check-t
;

test1

s" another test" >transient-string to s2

test: test2
    s2 object? check-t
    s2 string? check-t
    s2 string-length 12 = check-t
    s2 check-string string-length 12 = check-t
    s2 string> s" another test" str= tag-boolean check-t
    s2 check-string string> s" another test" str= tag-boolean check-t
;

test2

\ make sure the second string doesn't disturb the first
test1

s"  and " >transient-string to s3

test: test3
    s1 s3 concat to s4
    s4 object? check-t
    s4 string? check-t
    s4 string> s" this is a test and " str= tag-boolean check-t
    s4 ~string
    0 to s4
    s1 s3 concat s2 concat string> s" this is a test and another test" str= tag-boolean check-t
;

test3

test: test4
    10000 0 do
        s" this is a test" >transient-string to s1
        s" another test" >transient-string to s2
        s"  and " >transient-string to s3
        s1 s3 concat s2 concat to s4
        s4 object? check-t
        s4 string? check-t
        s4 string> s" this is a test and another test" str= tag-boolean check-t
        s" x" >string s4 over concat ~string ~string
        s1 ~string
        s2 ~string
        s3 ~string
        s4 ~string
        0 to s1
        0 to s2
        0 to s3
        0 to s4
    loop
;

test4

test: test5
    "this is a test" local s
    s 0 string-char 't' = check-t
    \ index out of range returns 0
    s 42 string-char 0= check-t
    s -1 string-char 0= check-t
;

test5

test: test6
    "this is a test" local s1
    "this is a test" local s2
    s1 s2 string-equal? check-t
    s1 s2 string= check-t
    s" this is a test" >string local s3
    s1 s3 string= check-t
    s3 ~string
    s3 string? check-false
    s" this is a test" >transient-string local s4
    s1 s4 string= check-t
    s" this is a test" >string local s5
    s1 s5 string= check-t
    s5 ~string
    s5 string? check-false
    "this is not a test" local s6
    s1 s6 string= check-false
    "this is a text" local s7
    s1 s7 string= check-false
;

test6

test: test7
    "this is a test" to s1
    s1 0 4 string-substring to s2
    s2 string? check-t
    s2 string-length 4 = check-t
    s2 "this" string= check-t

    \ s2 copies its data
    s1 string-data s2 string-data = check-false

    \ can't destroy s1 because it's a static string
    s1 ~string
    s1 string? check-t

    s2 ~string
    s2 string? f = check-t
;

test7

test: test8
    "this is another test" to s1
    'x' s1 string-find-char  f = check-t
    's' s1 string-find-char  3 = check-t
    'a' s1 string-find-char  8 = check-t
    'n' s1 string-find-char  9 = check-t
    't' s1 string-find-char  0 = check-t
    'e' s1 string-find-char 13 = check-t

    \ can't destroy s1 because it's a static string
    s1 ~string
    s1 string? check-t
;

test8

test: test9
    s" this is a test" >string to s1
    s1 string? check-t
\     s1 handle? check
    s1 ~string
\     s1 handle? check
    s1 object? f = check-t
    s1 string? f = check-t
;

test9

\ string-equal?
test: test10
    "test" "test" string-equal? t = check-t
    "test" "text" string-equal? f = check-t
    42 "test" string-equal? f = check-t
    "test" 89 string-equal? f = check-t
    42 17 string-equal? f = check-t

    s" testing" >transient-string "testing" string-equal? t = check-t
    s" testing" >transient-string s" testing" >string string-equal? t = check-t
;

test10

empty

cr .( Reached end of string-tests )
